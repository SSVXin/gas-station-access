<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script>
    // 微信环境特殊处理
    if(/MicroMessenger/i.test(navigator.userAgent)) {
        window.addEventListener('load', function() {
            // 区分iOS和安卓
            var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            if (isIOS) {
                // iOS微信中自动跳转到浏览器打开
                var openInBrowserTip = document.createElement('div');
                openInBrowserTip.style.position = 'fixed';
                openInBrowserTip.style.top = '0';
                openInBrowserTip.style.left = '0';
                openInBrowserTip.style.width = '100%';
                openInBrowserTip.style.padding = '10px';
                openInBrowserTip.style.backgroundColor = '#ffeb3b';
                openInBrowserTip.style.color = '#333';
                openInBrowserTip.style.textAlign = 'center';
                openInBrowserTip.style.zIndex = '9999';
                openInBrowserTip.innerHTML = '在iOS微信中扫码可能出现问题，请点击右上角···，选择"在浏览器中打开"';
                document.body.appendChild(openInBrowserTip);
                
                // 创建一个"复制链接"按钮
                var copyLinkBtn = document.createElement('button');
                copyLinkBtn.innerText = '复制链接';
                copyLinkBtn.style.marginLeft = '10px';
                copyLinkBtn.style.padding = '5px 10px';
                copyLinkBtn.addEventListener('click', function() {
                    var tempInput = document.createElement('input');
                    tempInput.value = window.location.href;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    alert('链接已复制，请在Safari浏览器中粘贴打开');
                });
                openInBrowserTip.appendChild(copyLinkBtn);
            } else {
                // 安卓微信中提示
                alert("建议点击右上角···，选择'在浏览器打开'以正常使用");
            }
        });
    }
    </script>
    <style>
        .container { max-width: 600px; margin: 20px auto; padding: 15px; }
        .stats { background: #f0f0f0; padding: 10px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .warning { color: red; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 实时人数 -->
        <div class="stats" id="currentStats">
            正在加载实时数据...
        </div>

        <!-- 登记表单 -->
        <h2 id="locationTitle"></h2>
        <form onsubmit="submitForm(event)">
            <div>
                <label>姓名：</label>
                <input type="text" name="name" required>
            </div>
            <div>
                <label>工号：</label>
                <input type="text" name="employee_id" required>
            </div>
            <div class="purpose-selection">
                <label>事由：</label>
                <select name="purpose">
                    <option value="作业">作业</option>
                    <option value="检查">检查</option>
                    <option value="参观">参观</option>
                    <option value="其他">其他</option>
                </select>
            </div>
            <div class="purpose-display" style="display:none;">
                <label>事由：</label>
                <span id="purposeDisplay" style="font-weight:bold;"></span>
                <!-- 隐藏的事由字段，在表单提交时使用 -->
                <input type="hidden" name="purpose_out" id="purpose_out" value="其他">
            </div>
            <button type="submit">登记</button>
        </form>

        <!-- 安全提示 -->
        <div class="warning">
            <h3>安全提示</h3>
            <ol>
                <li>必须静电消除</li>
                <li>非防爆手机不得携带入内</li>
                <li>区域内禁止烟火</li>
                <li>必须携带相应报警仪</li>
                <li>外来人员请在管理人员带领下进入</li>
            </ol>
        </div>

        <!-- 进出记录表格 -->
        <table id="recordsTable">
            <thead>
                <tr>
                    <th>姓名</th>
                    <th>事由</th>
                    <th>进入时间</th>
                    <th>持续时间</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

<script>
// LeanCloud配置
const APP_ID = '2ZmC6sqLRb9RZu5esRlf0Rtg-gzGzoHsz';
const APP_KEY = '4MOhNRmTw2JsXaJTTr2BzjLc';
const API_BASE = `https://2zmc6sql.lc-cn-n1-shared.com`;
const CLASS_NAME = 'AccessRecord';

// 全局参数
let currentLocation = '';
let currentDirection = '';

// 初始化页面
document.addEventListener('DOMContentLoaded', () => {
    // 从本地存储读取
    const savedInfo = JSON.parse(localStorage.getItem('userInfo'));
    if (savedInfo) {
        document.querySelector('[name="name"]').value = savedInfo.name || '';
        document.querySelector('[name="employee_id"]').value = savedInfo.employee_id || '';
    }

    const urlParams = new URLSearchParams(window.location.search);
    currentLocation = decodeURIComponent(urlParams.get('location'));
    currentDirection = urlParams.get('direction');
    
    document.getElementById('locationTitle').innerText = 
        `${currentLocation} - ${currentDirection === 'in' ? '进入' : '离开'}登记`;
    
    // 如果是出门记录，查询对应的进门事由并预填充
    if (currentDirection === 'out' && savedInfo && savedInfo.id) {
        document.querySelector('.purpose-selection').style.display = 'none'; // 隐藏事由选择
        document.querySelector('.purpose-display').style.display = 'block'; // 显示事由文本
        fetchAndSetPurpose(savedInfo.id, currentLocation);
    }
    
    loadRealTimeData();
    setInterval(loadRealTimeData, 5000); // 5秒刷新
});

// 获取并设置出门事由
async function fetchAndSetPurpose(employeeId, location) {
    try {
        // 查询该用户对该门禁的最近一次进入记录
        const query = encodeURIComponent(JSON.stringify({
            employee_id: employeeId,
            location: location,
            direction: 'in'
        }));
        
        const response = await fetch(`${API_BASE}/1.1/classes/AccessRecord?where=${query}&order=-createdAt&limit=1`, {
            headers: { 'X-LC-Id': APP_ID, 'X-LC-Key': `${APP_KEY},master` }
        });
        
        if (response.ok) {
            const data = await response.json();
            // 如果找到进入记录，使用进入记录的事由
            if (data.results && data.results.length > 0) {
                const purpose = data.results[0].purpose || '其他';
                // 设置隐藏的事由输入框的值
                document.querySelector('[name="purpose_out"]').value = purpose;
                // 显示事由文本
                document.getElementById('purposeDisplay').textContent = purpose;
            } else {
                document.querySelector('.purpose-selection').style.display = 'block'; // 找不到记录时显示选择
                document.querySelector('.purpose-display').style.display = 'none';
            }
        }
    } catch (error) {
        console.error('获取进门记录失败:', error);
        // 错误时显示选择框
        document.querySelector('.purpose-selection').style.display = 'block';
        document.querySelector('.purpose-display').style.display = 'none';
    }
}

// 加载实时数据
async function loadRealTimeData() {
  try {
    const query = encodeURIComponent(JSON.stringify({
      location: currentLocation,
      createdAt: { "$gte": { "__type": "Date", "iso": new Date(Date.now()-86400000).toISOString() }
    }}));

    // 设置15秒超时
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000);

    const response = await fetch(`${API_BASE}/1.1/classes/AccessRecord?where=${query}`, {
      headers: { 'X-LC-Id': APP_ID, 'X-LC-Key': `${APP_KEY},master` },
      signal: controller.signal
    });
    clearTimeout(timeoutId);

    // ++++ 增加响应状态检查 ++++
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`HTTP错误! 状态码: ${response.status}, 详情: ${errorText}`);
    }

    const data = await response.json();
    const activeRecords = calculateActiveRecords(data.results);
    
    // 更新显示
    document.getElementById('currentStats').innerHTML = `
      <p>当前区域人数: <strong>${activeRecords.length}</strong> 人</p>
    `;
    
    updateRecordsTable(activeRecords);
  } catch (error) {
    console.error('数据加载失败:', error);
    document.getElementById('currentStats').innerHTML = '数据加载失败，请检查网络';
  }
}

// 计算有效记录
function calculateActiveRecords(records) {
    const statusMap = new Map();
    
    records.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
    
    records.forEach(record => {
        const key = record.employee_id;
        if (record.direction === 'in') {
            statusMap.set(key, record);
        } else {
            statusMap.delete(key);
        }
    });
    
    return Array.from(statusMap.values());
}

// 更新表格
function updateRecordsTable(records) {
    const tbody = document.querySelector('#recordsTable tbody');
    tbody.innerHTML = records.map(record => {
        // 确保每个字段都有有效的值
        const name = record.name || '-';
        const purpose = record.purpose || '-';
        
        return `
        <tr>
            <td>${name}</td>
            <td>${purpose}</td>
            <td>${formatTime(record.createdAt)}</td>
            <td>${calculateDuration(record.createdAt)}</td>
        </tr>
    `}).join('');
}

// 时间格式化
function formatTime(isoTime) {
    const date = new Date(isoTime);
    return `${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
}

// 计算持续时间
function calculateDuration(isoTime) {
    const mins = Math.floor((new Date() - new Date(isoTime)) / 60000);
    return `${Math.floor(mins)}分钟`;
}

// ================ 修改点1：表单提交函数 ================
async function submitForm(e) {
  e.preventDefault();
  
  // 新增：获取表单数据
  const formData = {
    name: e.target.name.value.trim(),
    employee_id: e.target.employee_id.value.trim(),
    purpose: currentDirection === 'in' ? e.target.purpose.value : document.getElementById('purpose_out').value,
    location: currentLocation,
    direction: currentDirection
  };

  // 新增：本地存储
  try {
    localStorage.setItem('userInfo', JSON.stringify({
      name: formData.name,
      id: formData.employee_id
    }));
  } catch (error) {
    console.log('本地存储失败:', error);
  }

  // 对于出门记录，自动关联进门时的事由
  if (currentDirection === 'out') {
    try {
      // 查询该用户对该门禁的最近一次进入记录
      const query = encodeURIComponent(JSON.stringify({
        employee_id: formData.employee_id,
        location: currentLocation,
        direction: 'in'
      }));
      
      const response = await fetch(`${API_BASE}/1.1/classes/AccessRecord?where=${query}&order=-createdAt&limit=1`, {
        headers: { 'X-LC-Id': APP_ID, 'X-LC-Key': `${APP_KEY},master` }
      });
      
      if (response.ok) {
        const data = await response.json();
        // 如果找到进入记录，使用进入记录的事由
        if (data.results && data.results.length > 0) {
          const inPurpose = data.results[0].purpose;
          if (inPurpose && inPurpose !== 'undefined' && inPurpose !== 'null') {
            console.log('找到进门事由:', inPurpose);
            formData.purpose = inPurpose;
          } else {
            console.log('进门事由无效，使用默认值');
          }
        } else {
          console.log('未找到对应的进门记录');
        }
      }
    } catch (error) {
      console.error('获取进门记录失败:', error);
      // 获取失败时使用默认选择的事由，不影响后续操作
    }
  }

  // 确保事由字段有值
  if (!formData.purpose || formData.purpose === 'undefined' || formData.purpose === 'null') {
    formData.purpose = '其他';
  }

  console.log('提交数据:', formData);

  // ================ 修改点2：请求配置 ================
  try {
    const response = await fetch(`${API_BASE}/1.1/classes/${CLASS_NAME}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-LC-Id': APP_ID,
        'X-LC-Key': `${APP_KEY},master`
      },
      body: JSON.stringify(formData)
    });

    // 新增：精确错误处理
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`API错误: ${errorData.code} - ${errorData.error}`);
    }

    alert('登记成功！');
    e.target.reset();
    loadRealTimeData();
  } catch (error) {
    console.error('提交失败:', error);
    alert(`登记失败: ${error.message}`);
  }
}

// ================ 修改点3：自动填充 ================
document.addEventListener('DOMContentLoaded', () => {
  // 新增：自动填充
  try {
    const saved = JSON.parse(localStorage.getItem('userInfo'));
    if (saved) {
      document.querySelector('[name="name"]').value = saved.name || '';
      document.querySelector('[name="employee_id"]').value = saved.id || '';
    }
  } catch (error) {
    console.log('读取本地存储失败:', error);
  }
});


</script>
</body>
</html>

<!-- 在原有表单代码之后添加 -->
<div style="margin-top: 15px; font-size: 0.9em;">
    <button onclick="clearLocalStorage()" 
            style="background: #f0f0f0; padding: 5px 10px; border: 1px solid #ccc;">
      清除我的历史信息
    </button>
  </div>
  
  <script>
  function clearLocalStorage() {
    localStorage.removeItem('userInfo');
    alert('已清除本地保存的信息');
    window.location.reload();
  }
  </script>
