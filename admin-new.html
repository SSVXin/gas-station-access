<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>区域出入管理系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .login-card {
            max-width: 400px;
            margin: 100px auto;
        }
        .btn-primary {
            background-color: #0d6efd;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #0d6efd;
        }
        .date-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .date-filter label {
            margin-bottom: 0;
            white-space: nowrap;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        #manualModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 500px;
            margin: 100px auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <!-- 登录部分 -->
    <div id="loginBox" class="login-card">
        <div class="card">
            <div class="card-body p-4">
                <h3 class="text-center mb-4">管理员登录</h3>
                <div class="mb-3">
                    <label for="inputPwd" class="form-label">管理员密码</label>
                    <input type="password" class="form-control" id="inputPwd" placeholder="请输入密码">
                </div>
                <button class="btn btn-primary w-100" onclick="checkPassword()">登录</button>
                <p id="loginError" class="text-danger text-center mt-3"></p>
            </div>
        </div>
    </div>

    <!-- 主要内容部分，初始隐藏 -->
    <div id="contentDiv" class="main-container d-none">
        <h2 class="text-center mb-4">区域出入管理系统</h2>
        
        <!-- 导航标签页 -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="records-tab" data-bs-toggle="tab" data-bs-target="#records" type="button" role="tab">实时人员</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="supplementary-tab" data-bs-toggle="tab" data-bs-target="#supplementary" type="button" role="tab">补登记管理</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">系统管理</button>
            </li>
        </ul>
        
        <!-- 标签页内容 -->
        <div class="tab-content" id="adminTabContent">
            <!-- 实时人员 -->
            <div class="tab-pane fade show active" id="records" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="date-filter">
                                    <label for="locationFilter">区域筛选:</label>
                                    <select id="locationFilter" class="form-select">
                                        <option value="">全部区域</option>
                                        <!-- 自动填充选项 -->
                                    </select>
                                    
                                    <button class="btn btn-primary" onclick="loadRealTimeData()">刷新数据</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table id="dataTable" class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>姓名</th>
                                        <th>工号</th>
                                        <th>事由</th>
                                        <th>地点</th>
                                        <th>进入时间</th>
                                        <th>已持续时间</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <!-- 添加分页和计数信息 -->
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div id="dataTableCount" class="text-muted">共 0 条记录</div>
                                <div class="d-flex align-items-center">
                                    <span class="me-2">每页显示:</span>
                                    <select id="dataPageSize" class="form-select form-select-sm" style="width: auto;" onchange="changePageSize('data')">
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                    <nav class="ms-3">
                                        <ul id="dataTablePagination" class="pagination pagination-sm mb-0"></ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 补登记管理 -->
            <div class="tab-pane fade" id="supplementary" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <div class="btn-toolbar">
                                            <button class="btn btn-primary me-2" onclick="loadRecords()">查询原始记录</button>
                                            <button class="btn btn-warning me-2" onclick="showManualForm()">手动补登记</button>
                                            <button class="btn btn-info me-2" onclick="registerFromSelected()">从选中记录补登</button>
                                            <button class="btn btn-success" onclick="exportCSV()">导出CSV</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <div class="date-filter d-flex align-items-center">
                                            <label for="queryStartDate" class="me-2">开始日期:</label>
                                            <input type="text" class="form-control me-3" id="queryStartDate" placeholder="选择开始日期">
                                            
                                            <label for="queryEndDate" class="me-2">结束日期:</label>
                                            <input type="text" class="form-control" id="queryEndDate" placeholder="选择结束日期">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table id="recordsTable" class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th width="40px"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                                        <th>姓名</th>
                                        <th>工号</th>
                                        <th>事由</th>
                                        <th>门禁位置</th>
                                        <th>进出方向</th>
                                        <th>时间</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <!-- 添加分页和计数信息 -->
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div id="recordsTableCount" class="text-muted">共 0 条记录</div>
                                <div class="d-flex align-items-center">
                                    <span class="me-2">每页显示:</span>
                                    <select id="recordsPageSize" class="form-select form-select-sm" style="width: auto;" onchange="changePageSize('records')">
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                    <nav class="ms-3">
                                        <ul id="recordsTablePagination" class="pagination pagination-sm mb-0"></ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 系统管理 -->
            <div class="tab-pane fade" id="system" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5>数据维护</h5>
                        <div class="mb-3">
                            <button class="btn btn-danger" onclick="cleanOldData()">清理3个月前数据</button>
                            <p class="text-muted mt-2">此操作将永久删除3个月前的所有数据记录，请谨慎操作。</p>
                        </div>
                        
                        <hr>
                        
                        <h5>安全设置</h5>
                        <div class="mb-3">
                            <button class="btn btn-secondary" onclick="logoutAdmin()">退出登录</button>
                            <p class="text-muted mt-2">退出后需要重新输入密码才能访问管理界面。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 补登记模态框 -->
    <div id="manualModal">
        <div class="modal-content">
            <h4 class="mb-3">手动补登离开记录</h4>
            <div class="mb-3">
                <label for="manual_id" class="form-label">工号</label>
                <input type="text" class="form-control" id="manual_id">
            </div>
            <div class="mb-3">
                <label for="manual_loc" class="form-label">门禁位置</label>
                <select id="manual_loc" class="form-select">
                    <!-- 通过JS动态填充 -->
                </select>
            </div>
            <div class="mb-3">
                <label for="manual_time" class="form-label">离开时间</label>
                <input type="datetime-local" class="form-control" id="manual_time">
                <small class="text-muted">请选择实际离开的时间</small>
            </div>
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-secondary" onclick="closeModal()">取消</button>
                <button class="btn btn-primary" onclick="submitManual()">提交</button>
            </div>
        </div>
    </div>

    <!-- 引入JS库 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
    
    <script>
    // LeanCloud配置
    const APP_ID = '2ZmC6sqLRb9RZu5esRlf0Rtg-gzGzoHsz';
    const APP_KEY = '4MOhNRmTw2JsXaJTTr2BzjLc';
    const API_BASE = `https://2zmc6sql.lc-cn-n1-shared.com`;
    
    // 管理员密码 (注意：在生产环境中应该考虑更安全的方式)
    const ADMIN_PASSWORD = 'dlxj321';
    
    // 分页相关变量
    const defaultItemsPerPage = 10; // 默认每页显示10条记录
    let itemsPerPage = defaultItemsPerPage;
    let recordsItemsPerPage = defaultItemsPerPage;
    let currentPage = 1; // 实时人员的当前页
    let recordsCurrentPage = 1; // 补登记管理的当前页
    let recordsData = []; // 存储补登记管理的原始数据
    
    // 初始化日期选择器
    document.addEventListener('DOMContentLoaded', () => {
        initDatePickers();
        initLocations();
        checkLoginStatus();
        
        // 使所有标签页正确工作
        const triggerTabList = [].slice.call(document.querySelectorAll('#adminTabs button'));
        triggerTabList.forEach(function (triggerEl) {
            new bootstrap.Tab(triggerEl);
        });
        
        // 初始加载实时人员数据
        loadRealTimeData();
        
        // 设置自动刷新实时数据 (每60秒)
        setInterval(loadRealTimeData, 60000);
        
        // 初始化页面大小选择器
        document.getElementById('dataPageSize').value = itemsPerPage;
        document.getElementById('recordsPageSize').value = recordsItemsPerPage;
    });
    
    // 初始化日期选择器
    function initDatePickers() {
        const dateConfig = {
            locale: "zh",
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "Y年m月d日",
            maxDate: "today"
        };
        
        flatpickr("#queryStartDate", dateConfig);
        flatpickr("#queryEndDate", dateConfig);
    }
    
    // 登录相关函数
    function checkPassword() {
        const input = document.getElementById('inputPwd').value;
        if(input === ADMIN_PASSWORD) {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('contentDiv').classList.remove('d-none');
            
            // 使用sessionStorage而不是localStorage，这样关闭浏览器后自动失效
            sessionStorage.setItem('adminAuth', 'true');
        } else {
            document.getElementById('loginError').innerText = '密码错误，请重试';
        }
    }
    
    function checkLoginStatus() {
        // 使用sessionStorage检查登录状态，关闭浏览器后自动失效
        if(sessionStorage.getItem('adminAuth') === 'true') {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('contentDiv').classList.remove('d-none');
        }
    }
    
    function logoutAdmin() {
        sessionStorage.removeItem('adminAuth');
        document.getElementById('loginBox').style.display = 'block';
        document.getElementById('contentDiv').classList.add('d-none');
    }
    
    // 初始化地点选项
    function initLocations() {
        const locations = [
            "能环部能中1#煤气站",
            "能环部能中2#煤气站",
            "能环部能中3#煤气站",
            "能环部能中4#煤气站",
            "能环部能中5#煤气站",
            "能环部能中球罐区",
            "能环部能中放散塔",
        ];
        
        // 初始化主查询的位置筛选器
        const locationFilter = document.getElementById('locationFilter');
        locationFilter.innerHTML = '<option value="">全部区域</option>';
        
        // 初始化补登记的位置选择器
        const manualLoc = document.getElementById('manual_loc');
        manualLoc.innerHTML = '';
        
        locations.forEach(loc => {
            const option1 = document.createElement('option');
            option1.value = loc;
            option1.text = loc;
            locationFilter.appendChild(option1);
            
            const option2 = document.createElement('option');
            option2.value = loc;
            option2.text = loc;
            manualLoc.appendChild(option2);
        });
    }
    
    // ========== 实时人员功能 ==========
    
    // 加载实时人员数据
    async function loadRealTimeData() {
        try {
            // 查询所有记录，不预先筛选方向，而是后续在代码中分析谁真正在区域内
            const location = document.getElementById('locationFilter').value;
            
            // 构建查询条件
            const where = {};
            if (location) {
                where.location = location;
            }
            
            // 只查询最近30天的记录，避免处理过多历史数据
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            where.createdAt = { "$gte": { "__type": "Date", "iso": thirtyDaysAgo.toISOString() } };
            
            // 获取所有记录
            const response = await fetch(`${API_BASE}/1.1/classes/AccessRecord?where=${encodeURIComponent(JSON.stringify(where))}&limit=1000&order=createdAt`, {
                headers: { 
                    'X-LC-Id': APP_ID, 
                    'X-LC-Key': `${APP_KEY},master` 
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP错误: ${response.status}`);
            }
            
            const data = await response.json();
            console.log("获取到总记录数:", data.results.length);
            
            // 找出真正在区域内的人员
            const peopleInside = findPeopleCurrentlyInside(data.results);
            console.log("当前在区域内人数:", peopleInside.length);
            
            // 渲染表格
            renderRealTimeTable(peopleInside);
        } catch (error) {
            console.error("加载实时数据失败:", error);
            alert("加载实时人员数据失败: " + error.message);
        }
    }
    
    // 分析记录找出当前在区域内的人员
    function findPeopleCurrentlyInside(records) {
        // 按人员ID和位置分组的最新状态
        const latestStatus = new Map();
        
        // 先按时间排序，确保正确处理
        records.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
        
        // 处理每条记录
        for (const record of records) {
            const key = `${record.employee_id}_${record.location}`;
            
            // 更新该人员在该位置的最新状态
            latestStatus.set(key, record);
        }
        
        // 只保留最新状态为"进入"的记录
        const activeUsers = [];
        for (const [key, record] of latestStatus.entries()) {
            if (record.direction === 'in') {
                activeUsers.push({
                    ...record,
                    duration: calculateDuration(record.createdAt, new Date().toISOString())
                });
            }
        }
        
        return activeUsers;
    }
    
    // 渲染实时人员表格
    function renderRealTimeTable(users) {
        const tbody = document.querySelector('#dataTable tbody');
        
        // 计算当前页显示的记录
        const totalItems = users.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        currentPage = Math.min(currentPage, totalPages || 1);
        
        // 更新分页器
        updatePagination('dataTablePagination', totalPages, currentPage, () => renderRealTimeTable(users));
        
        // 获取当前页的数据
        const startIndex = (currentPage - 1) * itemsPerPage;
        const currentPageItems = users.slice(startIndex, startIndex + itemsPerPage);
        
        // 渲染表格
        tbody.innerHTML = currentPageItems.map(user => `
            <tr>
                <td>${user.name || '-'}</td>
                <td>${user.employee_id || '-'}</td>
                <td>${user.purpose || '-'}</td>
                <td>${user.location || '-'}</td>
                <td>${formatDateTime(user.createdAt)}</td>
                <td>${user.duration || '-'}</td>
            </tr>
        `).join('');
        
        // 显示记录总数
        const countInfo = document.getElementById('dataTableCount');
        if (countInfo) {
            countInfo.textContent = `共 ${totalItems} 人在区域内`;
        }
    }
    
    // ========== 补登记功能 ==========
    
    // 加载原始记录
    async function loadRecords() {
        const startDate = document.getElementById('queryStartDate').value;
        const endDate = document.getElementById('queryEndDate').value;
        
        const where = {};
        if(startDate || endDate) {
            where.createdAt = {};
            if(startDate) where.createdAt.$gte = { "__type": "Date", "iso": startDate + "T00:00:00.000Z" };
            if(endDate) where.createdAt.$lte = { "__type": "Date", "iso": endDate + "T23:59:59.999Z" };
        }

        try {
            const res = await fetch(`${API_BASE}/1.1/classes/AccessRecord?where=${encodeURIComponent(JSON.stringify(where))}&order=-createdAt&limit=1000`, {
                headers: { 'X-LC-Id': APP_ID, 'X-LC-Key': `${APP_KEY},master` }
            });
            
            const data = await res.json();
            recordsData = data.results; // 保存数据供后续使用
            renderRecordsTable(data.results);
        } catch (error) {
            console.error('查询失败:', error);
            alert('查询失败: ' + error.message);
        }
    }
    
    // 导出CSV
    async function exportCSV() {
        try {
            const startDate = document.getElementById('queryStartDate').value;
            const endDate = document.getElementById('queryEndDate').value;
            
            const where = {};
            if(startDate || endDate) {
                where.createdAt = {};
                if(startDate) where.createdAt.$gte = { "__type": "Date", "iso": startDate + "T00:00:00.000Z" };
                if(endDate) where.createdAt.$lte = { "__type": "Date", "iso": endDate + "T23:59:59.999Z" };
            }

            let allRecords = [];
            let skip = 0;
            const limit = 1000; // LeanCloud单次查询上限
            
            while(true) {
                const query = `where=${encodeURIComponent(JSON.stringify(where))}&order=createdAt&limit=${limit}&skip=${skip}`;
                const res = await fetch(`${API_BASE}/1.1/classes/AccessRecord?${query}`, {
                    headers: { 'X-LC-Id': APP_ID, 'X-LC-Key': `${APP_KEY},master` }
                });
                
                const data = await res.json();
                if(!data.results || data.results.length === 0) break;
                
                allRecords = allRecords.concat(data.results);
                skip += limit;
            }

            if(allRecords.length === 0) {
                alert('没有数据可导出');
                return;
            }
            
            exportDataToCSV(allRecords);
        } catch(error) {
            console.error('导出失败:', error);
            alert('导出失败: ' + error.message);
        }
    }
    
    // 实际执行导出CSV操作
    function exportDataToCSV(data) {
        if (!data || data.length === 0) {
            alert('没有数据可导出');
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";

        // 表头
        const headerRow = ["姓名", "工号", "事由", "地点", "进出方向", "时间"];
        csvContent += headerRow.map(h => `"${h}"`).join(',') + '\r\n';

        // 数据行
        data.forEach(record => {
            const row = [
                record.name || '-', // 姓名
                record.employee_id || '-', // 工号
                record.purpose || '-', // 事由
                record.location || '-', // 地点
                record.direction === 'in' ? '进入' : (record.direction === 'out' ? '离开' : '-'), // 进出方向
                formatDateTime(record.createdAt) // 时间
            ];
            csvContent += row.map(cell => `"${cell}"`).join(',') + '\r\n';
        });

        // 创建下载链接
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `进出记录_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 渲染原始记录表格
    function renderRecordsTable(records) {
        const tbody = document.querySelector('#recordsTable tbody');
        
        // 计算当前页显示的记录
        const totalItems = records.length;
        const totalPages = Math.ceil(totalItems / recordsItemsPerPage);
        recordsCurrentPage = Math.min(recordsCurrentPage, totalPages || 1);
        
        // 更新分页器
        updatePagination('recordsTablePagination', totalPages, recordsCurrentPage, () => renderRecordsTable(records));
        
        // 获取当前页的数据
        const startIndex = (recordsCurrentPage - 1) * recordsItemsPerPage;
        const currentPageItems = records.slice(startIndex, startIndex + recordsItemsPerPage);
        
        tbody.innerHTML = currentPageItems.map((record, index) => {
            const realIndex = startIndex + index; // 计算在原始数组中的索引
            return `
            <tr data-index="${realIndex}">
                <td>
                    <input type="checkbox" class="record-checkbox" data-index="${realIndex}">
                </td>
                <td>${record.name || '-'}</td>
                <td>${record.employee_id || '-'}</td>
                <td>${record.purpose || '-'}</td>
                <td>${record.location || '-'}</td>
                <td>${record.direction === 'in' ? '进入' : '离开'}</td>
                <td>${formatDateTime(record.createdAt)}</td>
            </tr>
        `}).join('');
        
        // 显示记录总数
        const countInfo = document.getElementById('recordsTableCount');
        if (countInfo) {
            countInfo.textContent = `共 ${totalItems} 条记录`;
        }
    }
    
    // 手动补登功能
    async function submitManual() {
        const employeeId = document.getElementById('manual_id').value.trim();
        const location = document.getElementById('manual_loc').value;
        const exitTime = document.getElementById('manual_time').value;
        
        if (!employeeId) {
            alert('请输入工号');
            return;
        }
        
        if (!exitTime) {
            alert('请选择离开时间');
            return;
        }

        // 验证是否有进入记录
        try {
            const checkRes = await fetch(`${API_BASE}/1.1/classes/AccessRecord?where=${encodeURIComponent(JSON.stringify({
                employee_id: employeeId,
                location: location,
                direction: "in"
            }))}&order=-createdAt&limit=1`, {
                headers: { 'X-LC-Id': APP_ID, 'X-LC-Key': `${APP_KEY},master` }
            });
            
            const checkData = await checkRes.json();
            if(checkData.results.length === 0) {
                alert('未找到对应的进入记录，请先确认人员已进入该区域');
                return;
            }
            
            // 使用最近的进入记录中的姓名
            const personName = checkData.results[0].name || "未知";
            
            // 构建离开记录时间
            const exitDateTime = new Date(exitTime);
            
            // 提交离开记录
            const submitRes = await fetch(`${API_BASE}/1.1/classes/AccessRecord`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-LC-Id': APP_ID,
                    'X-LC-Key': `${APP_KEY},master`
                },
                body: JSON.stringify({
                    employee_id: employeeId,
                    location: location,
                    direction: "out",
                    purpose: "管理员补登",
                    name: personName + "(管理员补登)",
                    createdAt: {
                        __type: "Date",
                        iso: exitDateTime.toISOString()
                    }
                })
            });
            
            if (submitRes.ok) {
                alert('补登成功！');
                closeModal();
                loadRecords(); // 刷新记录表
            } else {
                const errorData = await submitRes.json();
                throw new Error(`API错误: ${errorData.code} - ${errorData.error}`);
            }
            
        } catch (error) {
            console.error('补登失败:', error);
            alert('补登失败: ' + error.message);
        }
    }
    
    // 从选中记录补登
    function registerFromSelected() {
        const checkboxes = document.querySelectorAll('.record-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('请先选择一条记录');
            return;
        }
        
        if (checkboxes.length > 1) {
            alert('一次只能选择一条记录进行补登');
            return;
        }
        
        const index = parseInt(checkboxes[0].getAttribute('data-index'));
        const record = recordsData[index];
        
        if (record.direction !== 'in') {
            alert('只能为进入记录补登离开信息');
            return;
        }
        
        // 填充表单并显示
        document.getElementById('manual_id').value = record.employee_id;
        document.getElementById('manual_loc').value = record.location;
        
        // 设置默认补登时间为现在
        const now = new Date();
        document.getElementById('manual_time').value = 
            `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}T${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        
        showManualForm();
    }
    
    // 补登记相关函数
    function showManualForm() {
        document.getElementById('manualModal').style.display = 'block';
    }
    
    function closeModal() {
        document.getElementById('manualModal').style.display = 'none';
    }
    
    // ========== 系统管理功能 ==========
    
    // 清理旧数据
    async function cleanOldData() {
        const confirm = window.confirm('确定要删除3个月前的数据吗？此操作不可恢复！');
        if (!confirm) return;

        try {
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
            
            const where = {
                createdAt: { "$lt": { "__type": "Date", "iso": threeMonthsAgo.toISOString() } }
            };
            
            // 注意：LeanCloud API不支持批量删除，这里我们需要先查询出符合条件的记录
            const queryRes = await fetch(`${API_BASE}/1.1/classes/AccessRecord?where=${encodeURIComponent(JSON.stringify(where))}&limit=1000`, {
                headers: { 'X-LC-Id': APP_ID, 'X-LC-Key': `${APP_KEY},master` }
            });
            
            const data = await queryRes.json();
            
            if (data.results.length === 0) {
                alert('没有找到3个月前的数据');
                return;
            }
            
            // 确认是否继续删除
            const secondConfirm = window.confirm(`将删除 ${data.results.length} 条记录，确定继续吗？`);
            if (!secondConfirm) return;
            
            // 逐个删除记录
            let deleteCount = 0;
            for (const record of data.results) {
                const deleteRes = await fetch(`${API_BASE}/1.1/classes/AccessRecord/${record.objectId}`, {
                    method: 'DELETE',
                    headers: { 'X-LC-Id': APP_ID, 'X-LC-Key': `${APP_KEY},master` }
                });
                
                if (deleteRes.ok) {
                    deleteCount++;
                }
            }
            
            alert(`清理完成，成功删除 ${deleteCount} 条记录`);
        } catch (error) {
            console.error('清理失败:', error);
            alert('清理失败: ' + error.message);
        }
    }
    
    // ========== 工具函数 ==========
    
    // 时间格式化
    function formatDateTime(isoTime) {
        // 处理LeanCloud的Date对象格式
        let actualIso = isoTime;
        if (isoTime && typeof isoTime === 'object' && isoTime.iso) {
            actualIso = isoTime.iso;
        }
        if (!actualIso) return '-';
        
        const date = new Date(actualIso);
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }
    
    // 计算持续时间
    function calculateDuration(startTime, endTime) {
        if (!startTime || !endTime) return '-';
        
        const start = new Date(startTime);
        const end = new Date(endTime);
        const diffMs = end - start;
        
        // 如果时间差小于0，可能是数据错误
        if (diffMs < 0) return '时间错误';
        
        const diffMins = Math.floor(diffMs / 60000);
        const hours = Math.floor(diffMins / 60);
        const mins = diffMins % 60;
        
        if (hours > 0) {
            return `${hours}小时${mins}分钟`;
        } else {
            return `${mins}分钟`;
        }
    }
    
    // 关闭弹窗的其他方式
    window.onclick = function(event) {
        const modal = document.getElementById('manualModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    // 全选/取消全选
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.record-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    }
    
    // 更新分页器
    function updatePagination(paginationId, totalPages, currentPageNum, callback) {
        const pagination = document.getElementById(paginationId);
        if (!pagination) return;
        
        let paginationHTML = '';
        
        // 上一页按钮
        paginationHTML += `
            <li class="page-item ${currentPageNum <= 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPageNum - 1}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
        `;
        
        // 页码按钮
        const startPage = Math.max(1, currentPageNum - 2);
        const endPage = Math.min(totalPages, startPage + 4);
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <li class="page-item ${i === currentPageNum ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>
            `;
        }
        
        // 下一页按钮
        paginationHTML += `
            <li class="page-item ${currentPageNum >= totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPageNum + 1}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        `;
        
        pagination.innerHTML = paginationHTML;
        
        // 绑定事件
        const pageLinks = pagination.querySelectorAll('.page-link');
        pageLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const pageNum = parseInt(this.getAttribute('data-page'));
                if (paginationId === 'dataTablePagination') {
                    currentPage = pageNum;
                } else if (paginationId === 'recordsTablePagination') {
                    recordsCurrentPage = pageNum;
                }
                callback();
            });
        });
    }

    // 改变每页显示记录数
    function changePageSize(type) {
        if (type === 'data') {
            itemsPerPage = parseInt(document.getElementById('dataPageSize').value);
            currentPage = 1; // 重置为第一页
            loadRealTimeData(); // 重新加载数据
        } else if (type === 'records') {
            recordsItemsPerPage = parseInt(document.getElementById('recordsPageSize').value);
            recordsCurrentPage = 1; // 重置为第一页
            if (recordsData && recordsData.length > 0) {
                renderRecordsTable(recordsData); // 重新渲染表格
            }
        }
    }
    </script>
</body>
</html>
